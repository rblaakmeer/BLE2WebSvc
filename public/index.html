<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE2WebSvc - Device Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 500;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .device-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #fafafa;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .device-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .device-info {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .device-info strong {
            color: #333;
        }

        .connect-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.4);
        }

        .connect-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .services-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .service-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .service-uuid {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .characteristics-list {
            margin-top: 10px;
        }

        .characteristic-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .characteristic-uuid {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #666;
        }

        .read-btn {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: transform 0.2s;
            margin-right: 5px;
        }

        .read-btn:hover {
            transform: translateY(-1px);
        }

        .write-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .write-btn:hover {
            transform: translateY(-1px);
        }

        .subscribe-btn {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .subscribe-btn:hover {
            transform: translateY(-1px);
        }

        .subscribe-btn.subscribed {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .notifications-section {
            margin-top: 8px;
            padding: 10px;
            background: #f8f4ff;
            border-radius: 4px;
            border: 1px solid #8e44ad;
            max-height: 200px;
            overflow-y: auto;
        }

        .notification-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .notification-value {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 2px;
            margin: 4px 0;
            word-break: break-all;
        }

        .notification-time {
            color: #666;
            font-size: 0.7rem;
        }

        .write-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .write-section {
            margin-top: 8px;
            padding: 10px;
            background: #fff3e0;
            border-radius: 4px;
            border: 1px solid #ffcc02;
        }

        .button-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .characteristic-value {
            margin-top: 8px;
            padding: 8px;
            background: #e8f5e8;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .success {
            color: #2e7d32;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #4caf50;
        }

        .status-disconnected {
            background: #f44336;
        }

        .status-connecting {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BLE2WebSvc</h1>
            <p>Bluetooth Low Energy Device Manager</p>
        </div>
        
        <div class="content">
            <div class="section">
                <h2>Discovered Devices</h2>
                <button class="refresh-btn" onclick="refreshDevices()">ðŸ”„ Refresh Devices</button>
                <div id="devices-container">
                    <div class="loading">Loading devices...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let devices = [];
        let connectedDevices = new Set();

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            refreshDevices();
        });

        // Refresh the list of discovered devices
        async function refreshDevices() {
            const container = document.getElementById('devices-container');
            container.innerHTML = '<div class="loading">Loading devices...</div>';

            try {
                const response = await fetch('/ble/devices');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                devices = await response.json();
                displayDevices();
            } catch (error) {
                console.error('Error fetching devices:', error);
                container.innerHTML = `<div class="error">Failed to load devices: ${error.message}</div>`;
            }
        }

        // Display the list of devices
        function displayDevices() {
            const container = document.getElementById('devices-container');
            
            if (devices.length === 0) {
                container.innerHTML = '<div class="loading">No devices discovered yet. Make sure Bluetooth is enabled and devices are advertising.</div>';
                return;
            }

            const devicesHtml = devices.map(device => {
                const isConnected = connectedDevices.has(device.id);
                const statusClass = isConnected ? 'status-connected' : 'status-disconnected';
                const statusText = isConnected ? 'Connected' : 'Disconnected';
                
                return `
                    <div class="device-card" id="device-${device.id}">
                        <div class="device-name">
                            <span class="status-indicator ${statusClass}"></span>
                            ${device.name || 'Unknown Device'}
                        </div>
                        <div class="device-info">
                            <strong>ID:</strong> ${device.id}<br>
                            <strong>Address:</strong> ${device.address || 'N/A'}<br>
                            <strong>RSSI:</strong> ${device.rssi || 'N/A'} dBm<br>
                            <strong>Status:</strong> ${statusText}
                        </div>
                        <button class="connect-btn" onclick="toggleConnection('${device.id}')" 
                                ${isConnected ? '' : ''}>
                            ${isConnected ? 'Disconnect' : 'Connect'}
                        </button>
                        <div id="services-${device.id}" class="services-section" style="display: ${isConnected ? 'block' : 'none'}">
                            <!-- Services will be loaded here -->
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="device-grid">${devicesHtml}</div>`;
        }

        // Toggle connection to a device
        async function toggleConnection(deviceId) {
            const button = document.querySelector(`#device-${deviceId} .connect-btn`);
            const statusIndicator = document.querySelector(`#device-${deviceId} .status-indicator`);
            const servicesSection = document.getElementById(`services-${deviceId}`);
            
            const isConnected = connectedDevices.has(deviceId);
            
            // Update UI to show connecting state
            button.disabled = true;
            statusIndicator.className = 'status-indicator status-connecting';
            button.textContent = isConnected ? 'Disconnecting...' : 'Connecting...';

            try {
                if (isConnected) {
                    // Disconnect
                    const response = await fetch(`/ble/devices/${deviceId}/disconnect`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    connectedDevices.delete(deviceId);
                    statusIndicator.className = 'status-indicator status-disconnected';
                    button.textContent = 'Connect';
                    servicesSection.style.display = 'none';
                    servicesSection.innerHTML = '';
                    
                    // Clean up any active subscriptions for this device
                    cleanupSubscriptionsForDevice(deviceId);
                    
                } else {
                    // Connect
                    const response = await fetch(`/ble/devices/${deviceId}/connect`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
                    }
                    
                    connectedDevices.add(deviceId);
                    statusIndicator.className = 'status-indicator status-connected';
                    button.textContent = 'Disconnect';
                    
                    // Load services and characteristics
                    await loadServicesAndCharacteristics(deviceId);
                    servicesSection.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                statusIndicator.className = 'status-indicator status-disconnected';
                button.textContent = 'Connect';
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = `Connection failed: ${error.message}`;
                document.querySelector(`#device-${deviceId}`).appendChild(errorDiv);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 5000);
            } finally {
                button.disabled = false;
            }
        }

        // Load services and characteristics for a connected device
        async function loadServicesAndCharacteristics(deviceId) {
            const servicesSection = document.getElementById(`services-${deviceId}`);
            servicesSection.innerHTML = '<div class="loading">Loading services...</div>';

            try {
                // Get services
                const servicesResponse = await fetch(`/ble/devices/${deviceId}/services`);
                if (!servicesResponse.ok) {
                    throw new Error(`HTTP error! status: ${servicesResponse.status}`);
                }
                
                const services = await servicesResponse.json();
                
                if (services.length === 0) {
                    servicesSection.innerHTML = '<div class="loading">No services found.</div>';
                    return;
                }

                let servicesHtml = '<h3>Services & Characteristics</h3>';
                
                for (const service of services) {
                    servicesHtml += `
                        <div class="service-card">
                            <strong>Service:</strong> ${service.name || 'Unknown Service'}<br>
                            <div class="service-uuid">UUID: ${service.uuid}</div>
                            <div id="characteristics-${deviceId}-${service.uuid}" class="characteristics-list">
                                <div class="loading">Loading characteristics...</div>
                            </div>
                        </div>
                    `;
                }
                
                servicesSection.innerHTML = servicesHtml;
                
                // Load characteristics for each service
                for (const service of services) {
                    await loadCharacteristics(deviceId, service.uuid);
                }
                
            } catch (error) {
                console.error('Error loading services:', error);
                servicesSection.innerHTML = `<div class="error">Failed to load services: ${error.message}</div>`;
            }
        }

        // Load characteristics for a specific service
        async function loadCharacteristics(deviceId, serviceUuid) {
            const characteristicsContainer = document.getElementById(`characteristics-${deviceId}-${serviceUuid}`);
            
            try {
                const response = await fetch(`/ble/devices/${deviceId}/services/${serviceUuid}/characteristics`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const characteristics = await response.json();
                
                if (characteristics.length === 0) {
                    characteristicsContainer.innerHTML = '<div class="loading">No characteristics found.</div>';
                    return;
                }

                const characteristicsHtml = characteristics.map(char => {
                    const canRead = char.properties && char.properties.includes('read');
                    const canWrite = char.properties && (char.properties.includes('write') || char.properties.includes('writeWithoutResponse'));
                    const canNotify = char.properties && (char.properties.includes('notify') || char.properties.includes('indicate'));
                    
                    return `
                        <div class="characteristic-item">
                            <div>
                                <strong>${char.name || 'Unknown Characteristic'}</strong><br>
                                <div class="characteristic-uuid">UUID: ${char.uuid}</div>
                                <div style="font-size: 0.8rem; color: #888;">
                                    Properties: ${char.properties ? char.properties.join(', ') : 'N/A'}
                                </div>
                            </div>
                            <div class="button-group">
                                ${canRead ? 
                                    `<button class="read-btn" onclick="readCharacteristic('${deviceId}', '${char.uuid}')">Read</button>` : 
                                    ''
                                }
                                ${canWrite ? 
                                    `<button class="write-btn" onclick="toggleWriteSection('${deviceId}', '${char.uuid}')">Write</button>` : 
                                    ''
                                }
                                ${canNotify ? 
                                    `<button class="subscribe-btn" id="subscribe-btn-${deviceId}-${char.uuid}" onclick="toggleSubscription('${deviceId}', '${char.uuid}')">Subscribe</button>` : 
                                    ''
                                }
                                ${!canRead && !canWrite && !canNotify ? 
                                    '<span style="color: #ccc; font-size: 0.8rem;">No access available</span>' : 
                                    ''
                                }
                            </div>
                        </div>
                        <div id="value-${deviceId}-${char.uuid}" class="characteristic-value" style="display: none;"></div>
                        <div id="write-${deviceId}-${char.uuid}" class="write-section" style="display: none;">
                            <label for="write-input-${deviceId}-${char.uuid}">Enter hex value to write:</label>
                            <input type="text" id="write-input-${deviceId}-${char.uuid}" class="write-input" 
                                   placeholder="e.g., 48656c6c6f (hex string)" 
                                   pattern="[0-9a-fA-F]*"
                                   title="Enter a valid hex string (0-9, a-f, A-F)">
                            <div style="margin-top: 8px;">
                                <button class="write-btn" onclick="writeCharacteristic('${deviceId}', '${char.uuid}')">Send</button>
                                <button class="read-btn" onclick="toggleWriteSection('${deviceId}', '${char.uuid}')">Cancel</button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                ðŸ’¡ Tip: Enter data as hex string (e.g., "48656c6c6f" for "Hello")
                            </div>
                        </div>
                        <div id="notifications-${deviceId}-${char.uuid}" class="notifications-section" style="display: none;">
                            <h4>Live Notifications</h4>
                            <div id="notifications-list-${deviceId}-${char.uuid}"></div>
                        </div>
                    `;
                }).join('');

                characteristicsContainer.innerHTML = characteristicsHtml;
                
            } catch (error) {
                console.error('Error loading characteristics:', error);
                characteristicsContainer.innerHTML = `<div class="error">Failed to load characteristics: ${error.message}</div>`;
            }
        }

        // Read a characteristic value
        async function readCharacteristic(deviceId, characteristicUuid) {
            const button = event.target;
            const valueContainer = document.getElementById(`value-${deviceId}-${characteristicUuid}`);
            
            button.disabled = true;
            button.textContent = 'Reading...';
            
            try {
                const response = await fetch(`/ble/devices/${deviceId}/characteristics/${characteristicUuid}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Display the value
                valueContainer.innerHTML = `
                    <strong>Value:</strong> ${data.value || 'No data'}<br>
                    <small>Last read: ${new Date().toLocaleTimeString()}</small>
                `;
                valueContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error reading characteristic:', error);
                valueContainer.innerHTML = `<div class="error">Failed to read: ${error.message}</div>`;
                valueContainer.style.display = 'block';
            } finally {
                button.disabled = false;
                button.textContent = 'Read';
            }
        }

        // Toggle write section visibility
        function toggleWriteSection(deviceId, characteristicUuid) {
            const writeSection = document.getElementById(`write-${deviceId}-${characteristicUuid}`);
            const isVisible = writeSection.style.display === 'block';
            
            writeSection.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Focus on input when showing
                const input = document.getElementById(`write-input-${deviceId}-${characteristicUuid}`);
                setTimeout(() => input.focus(), 100);
            }
        }

        // Write a value to a characteristic
        async function writeCharacteristic(deviceId, characteristicUuid) {
            const input = document.getElementById(`write-input-${deviceId}-${characteristicUuid}`);
            const writeSection = document.getElementById(`write-${deviceId}-${characteristicUuid}`);
            const valueContainer = document.getElementById(`value-${deviceId}-${characteristicUuid}`);
            
            const hexValue = input.value.trim();
            
            // Validate hex input
            if (!hexValue) {
                alert('Please enter a hex value to write.');
                return;
            }
            
            if (!/^[0-9a-fA-F]*$/.test(hexValue)) {
                alert('Invalid hex format. Please use only 0-9 and a-f characters.');
                return;
            }
            
            if (hexValue.length % 2 !== 0) {
                alert('Hex string must have an even number of characters.');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Writing...';
            
            try {
                const response = await fetch(`/ble/devices/${deviceId}/characteristics/${characteristicUuid}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        value: hexValue,
                        withoutResponse: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Show success message
                valueContainer.innerHTML = `
                    <div class="success">
                        <strong>Write successful!</strong><br>
                        Value written: ${hexValue}<br>
                        <small>Written at: ${new Date().toLocaleTimeString()}</small>
                    </div>
                `;
                valueContainer.style.display = 'block';
                
                // Clear input and hide write section
                input.value = '';
                writeSection.style.display = 'none';
                
            } catch (error) {
                console.error('Error writing characteristic:', error);
                valueContainer.innerHTML = `<div class="error">Failed to write: ${error.message}</div>`;
                valueContainer.style.display = 'block';
            } finally {
                button.disabled = false;
                button.textContent = 'Send';
            }
        }

        // Store active subscriptions and polling intervals
        const activeSubscriptions = new Map();
        const pollingIntervals = new Map();

        // Toggle subscription to a characteristic
        async function toggleSubscription(deviceId, characteristicUuid) {
            const button = document.getElementById(`subscribe-btn-${deviceId}-${characteristicUuid}`);
            const notificationsSection = document.getElementById(`notifications-${deviceId}-${characteristicUuid}`);
            const subscriptionKey = `${deviceId}-${characteristicUuid}`;
            
            const isSubscribed = activeSubscriptions.has(subscriptionKey);
            
            button.disabled = true;
            button.textContent = isSubscribed ? 'Unsubscribing...' : 'Subscribing...';
            
            try {
                if (isSubscribed) {
                    // Unsubscribe
                    const response = await fetch(`/ble/devices/${deviceId}/characteristics/${characteristicUuid}/unsubscribe`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
                    }
                    
                    // Stop polling and clean up
                    const intervalId = pollingIntervals.get(subscriptionKey);
                    if (intervalId) {
                        clearInterval(intervalId);
                        pollingIntervals.delete(subscriptionKey);
                    }
                    
                    activeSubscriptions.delete(subscriptionKey);
                    button.textContent = 'Subscribe';
                    button.classList.remove('subscribed');
                    notificationsSection.style.display = 'none';
                    
                } else {
                    // Subscribe
                    const response = await fetch(`/ble/devices/${deviceId}/characteristics/${characteristicUuid}/subscribe`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.details || `HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    activeSubscriptions.set(subscriptionKey, {
                        deviceId,
                        characteristicUuid,
                        subscribedAt: new Date().toISOString(),
                        lastNotificationTime: 0
                    });
                    
                    button.textContent = 'Unsubscribe';
                    button.classList.add('subscribed');
                    notificationsSection.style.display = 'block';
                    
                    // Start polling for notifications
                    startNotificationPolling(deviceId, characteristicUuid);
                }
                
            } catch (error) {
                console.error('Subscription error:', error);
                
                // Show error message
                const valueContainer = document.getElementById(`value-${deviceId}-${characteristicUuid}`);
                valueContainer.innerHTML = `<div class="error">Subscription failed: ${error.message}</div>`;
                valueContainer.style.display = 'block';
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    if (valueContainer.innerHTML.includes('Subscription failed')) {
                        valueContainer.style.display = 'none';
                    }
                }, 5000);
                
            } finally {
                button.disabled = false;
            }
        }

        // Start polling for notifications from a subscribed characteristic
        function startNotificationPolling(deviceId, characteristicUuid) {
            const subscriptionKey = `${deviceId}-${characteristicUuid}`;
            const subscription = activeSubscriptions.get(subscriptionKey);
            
            if (!subscription) return;
            
            // Poll every 1 second for new notifications
            const intervalId = setInterval(async () => {
                try {
                    const response = await fetch(`/ble/devices/${deviceId}/characteristics/${characteristicUuid}/notifications?since=${subscription.lastNotificationTime}&limit=50`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Subscription no longer exists, stop polling
                            clearInterval(intervalId);
                            pollingIntervals.delete(subscriptionKey);
                            activeSubscriptions.delete(subscriptionKey);
                            
                            const button = document.getElementById(`subscribe-btn-${deviceId}-${characteristicUuid}`);
                            if (button) {
                                button.textContent = 'Subscribe';
                                button.classList.remove('subscribed');
                            }
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.notifications && data.notifications.length > 0) {
                        displayNotifications(deviceId, characteristicUuid, data.notifications);
                        
                        // Update last notification time
                        const lastNotification = data.notifications[data.notifications.length - 1];
                        subscription.lastNotificationTime = new Date(lastNotification.receivedAt).getTime();
                    }
                    
                } catch (error) {
                    console.error('Error polling notifications:', error);
                }
            }, 1000);
            
            pollingIntervals.set(subscriptionKey, intervalId);
        }

        // Display notifications in the UI
        function displayNotifications(deviceId, characteristicUuid, notifications) {
            const notificationsList = document.getElementById(`notifications-list-${deviceId}-${characteristicUuid}`);
            
            notifications.forEach(notification => {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification-item';
                
                const timestamp = new Date(notification.receivedAt).toLocaleTimeString();
                const notificationType = notification.isNotification ? 'Notification' : 'Indication';
                
                notificationDiv.innerHTML = `
                    <div><strong>${notificationType}</strong></div>
                    <div class="notification-value">${notification.value || 'No data'}</div>
                    <div class="notification-time">${timestamp}</div>
                `;
                
                // Add to top of list
                notificationsList.insertBefore(notificationDiv, notificationsList.firstChild);
                
                // Keep only the last 20 notifications visible
                while (notificationsList.children.length > 20) {
                    notificationsList.removeChild(notificationsList.lastChild);
                }
            });
        }

        // Clean up subscriptions when device disconnects
        function cleanupSubscriptionsForDevice(deviceId) {
            const keysToRemove = [];
            
            activeSubscriptions.forEach((subscription, key) => {
                if (subscription.deviceId === deviceId) {
                    keysToRemove.push(key);
                }
            });
            
            keysToRemove.forEach(key => {
                const intervalId = pollingIntervals.get(key);
                if (intervalId) {
                    clearInterval(intervalId);
                    pollingIntervals.delete(key);
                }
                activeSubscriptions.delete(key);
            });
        }
    </script>
</body>
</html>
